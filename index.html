<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>AR –ü—Ä–∏–º—ñ—Ä–∫–∞ —Ç–∞—Ç—É—é–≤–∞–Ω—å</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary-bg: rgba(15, 15, 20, 0.85);
      --accent-gold: #FFD700;
      --accent-red: #FF4757;
      --text-light: #FFFFFF;
      --text-muted: #A0A0A0;
      --panel-radius: 24px;
    }
    
    body {
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: var(--text-light);
      touch-action: none;
      -webkit-text-size-adjust: 100%;
    }
    
    #video, #overlayCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    
    #video { 
      z-index: 1; 
      transform: scaleX(-1);
    }
    
    #overlayCanvas { 
      z-index: 2; 
      pointer-events: auto;
      touch-action: pan-x pan-y pinch-zoom;
    }

    #langToggle {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 100;
      background: var(--primary-bg);
      color: var(--text-light);
      border: 1px solid rgba(255, 255, 255, 0.2);
      width: 44px;
      height: 44px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      backdrop-filter: blur(20px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }
    
    #langToggle:active {
      transform: scale(0.95);
    }

    #bodyPartPanel {
      position: fixed;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
      background: var(--primary-bg);
      padding: 12px;
      border-radius: var(--panel-radius);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 90vw;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    #bodyPartPanel::-webkit-scrollbar { 
      display: none; 
    }

    .body-part-btn {
      padding: 10px 14px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      color: var(--text-light);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      min-width: 85px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .body-part-btn:active {
      transform: scale(0.95);
    }
    
    .body-part-btn.active {
      background: linear-gradient(135deg, var(--accent-gold), #FFA500);
      color: #000;
      font-weight: bold;
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
      border-color: var(--accent-gold);
    }

    .panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: var(--primary-bg);
      padding: 14px;
      border-radius: var(--panel-radius);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 90vw;
      overflow-x: auto;
    }
    
    .panel::-webkit-scrollbar { 
      display: none; 
    }

    .btn {
      padding: 14px 18px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      color: var(--text-light);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      min-width: 110px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 0; 
      left: -100%;
      width: 100%; 
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }
    
    .btn:active::before {
      left: 100%;
    }
    
    .btn:active {
      transform: scale(0.95);
    }

    #tattooPicker {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: var(--primary-bg);
      padding: 12px;
      border-radius: var(--panel-radius);
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      max-width: 90vw;
      overflow-x: auto;
    }
    
    #tattooPicker::-webkit-scrollbar { 
      display: none; 
    }

    .tattoo-thumb {
      width: 65px; 
      height: 65px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 14px;
      background: white;
      cursor: pointer;
      object-fit: contain;
      transition: all 0.3s ease;
    }
    
    .tattoo-thumb:active {
      transform: scale(0.95);
    }
    
    .tattoo-thumb.selected { 
      border-color: var(--accent-gold); 
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
      transform: scale(1.05);
    }

    #loading {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background: #000; 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      z-index: 999;
      color: var(--text-light); 
      font-size: 18px;
      padding: 20px;
      text-align: center;
    }
    
    #loading p { 
      margin-top: 16px; 
      font-size: 14px; 
      color: var(--text-muted); 
    }

    #manualIndicator {
      position: fixed;
      top: 16px;
      left: 16px;
      background: rgba(255, 71, 87, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
      z-index: 100;
      display: none;
      backdrop-filter: blur(10px);
    }

    #debugInfo {
      position: fixed;
      top: 70px;
      left: 16px;
      background: rgba(0, 0, 0, 0.8);
      color: lime;
      padding: 10px;
      border-radius: 12px;
      font-size: 12px;
      z-index: 100;
      display: none;
      max-width: 300px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 255, 0, 0.3);
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö */
    @media (max-width: 768px) {
      .panel {
        bottom: 12px;
        padding: 12px;
        border-radius: 20px;
        gap: 8px;
      }
      
      .btn {
        padding: 12px 14px;
        font-size: 14px;
        min-width: 90px;
        border-radius: 16px;
      }
      
      #bodyPartPanel {
        bottom: 140px;
        padding: 10px;
        border-radius: 20px;
        gap: 8px;
      }
      
      .body-part-btn {
        padding: 8px 12px;
        font-size: 12px;
        min-width: 75px;
        border-radius: 14px;
      }
      
      #tattooPicker {
        bottom: 80px;
        padding: 10px;
        border-radius: 20px;
        gap: 10px;
      }
      
      .tattoo-thumb {
        width: 55px; 
        height: 55px;
        border-radius: 12px;
      }
      
      #langToggle {
        width: 40px; 
        height: 40px;
        font-size: 14px;
      }
    }

    @media (max-width: 480px) {
      .panel {
        flex-wrap: wrap;
        justify-content: center;
        max-width: 95vw;
        bottom: 8px;
      }
      
      #bodyPartPanel {
        flex-wrap: nowrap;
        overflow-x: auto;
        max-width: 95vw;
        bottom: 130px;
      }
      
      .btn {
        font-size: 13px;
        padding: 10px 12px;
        min-width: 80px;
      }
      
      #tattooPicker {
        bottom: 70px;
        max-width: 95vw;
      }
      
      .tattoo-thumb {
        width: 50px; 
        height: 50px;
      }
    }

    @media (max-width: 360px) {
      .btn {
        min-width: 70px;
        padding: 8px 10px;
        font-size: 12px;
      }
      
      .body-part-btn {
        min-width: 65px;
        font-size: 11px;
        padding: 6px 8px;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    üîç –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏ —Ç–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É...
    <p>–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="overlayCanvas"></canvas>

  <button id="langToggle">üá¨üáß</button>
  <div id="manualIndicator">–†—É—á–Ω–∏–π —Ä–µ–∂–∏–º</div>
  <div id="debugInfo"></div>

  <div id="tattooPicker"></div>
  <div id="bodyPartPanel"></div>

  <div class="panel">
    <button id="captureBtn" class="btn">üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
    <button id="uploadBtn" class="btn">‚ûï –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG</button>
    <button id="debugToggle" class="btn">üêõ –î–µ–±–∞–≥</button>
  </div>

  <input type="file" id="fileInput" accept="image/png" style="display:none" />

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>

  <script>
    // === –ú–æ–≤–∏ ===
    const LANGUAGES = {
      en: {
        title: "Tattoo Try-On AR",
        loading: "üîç Loading camera and pose detection...<br><p>Please allow camera access</p>",
        capture: "üì∏ Capture",
        upload: "‚ûï Upload PNG",
        manualMode: "Manual Mode",
        debug: "üêõ Debug",
        bodyParts: {
          "nose": "Nose",
          "leftEye": "Left Eye",
          "rightEye": "Right Eye",
          "leftEar": "Left Ear", 
          "rightEar": "Right Ear",
          "leftShoulder": "Left Shoulder",
          "rightShoulder": "Right Shoulder", 
          "leftElbow": "Left Elbow",
          "rightElbow": "Right Elbow",
          "leftWrist": "Left Wrist",
          "rightWrist": "Right Wrist",
          "leftHip": "Left Hip",
          "rightHip": "Right Hip",
          "leftKnee": "Left Knee",
          "rightKnee": "Right Knee",
          "leftAnkle": "Left Ankle",
          "rightAnkle": "Right Ankle"
        }
      },
      uk: {
        title: "AR –ü—Ä–∏–º—ñ—Ä–∫–∞ —Ç–∞—Ç—É",
        loading: "üîç –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏ —Ç–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É...<br><p>–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>",
        capture: "üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ",
        upload: "‚ûï –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG",
        manualMode: "–†—É—á–Ω–∏–π —Ä–µ–∂–∏–º",
        debug: "üêõ –î–µ–±–∞–≥",
        bodyParts: {
          "nose": "–ù—ñ—Å",
          "leftEye": "–õ—ñ–≤–µ –æ–∫–æ",
          "rightEye": "–ü—Ä–∞–≤–µ –æ–∫–æ",
          "leftEar": "–õ—ñ–≤–µ –≤—É—Ö–æ",
          "rightEar": "–ü—Ä–∞–≤–µ –≤—É—Ö–æ",
          "leftShoulder": "–õ—ñ–≤–µ –ø–ª–µ—á–µ",
          "rightShoulder": "–ü—Ä–∞–≤–µ –ø–ª–µ—á–µ",
          "leftElbow": "–õ—ñ–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "rightElbow": "–ü—Ä–∞–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "leftWrist": "–õ—ñ–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "rightWrist": "–ü—Ä–∞–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "leftHip": "–õ—ñ–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "rightHip": "–ü—Ä–∞–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "leftKnee": "–õ—ñ–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "rightKnee": "–ü—Ä–∞–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "leftAnkle": "–õ—ñ–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞",
          "rightAnkle": "–ü—Ä–∞–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞"
        }
      }
    };

    let currentLang = 'uk';
    let net = null;
    let debugMode = false;

    // === –ö–æ—Ä–µ–∫—Ç–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —á–∞—Å—Ç–∏–Ω —Ç—ñ–ª–∞ –¥–ª—è PoseNet ===
    const BODY_PARTS = [
      { 
        name: "nose", 
        keypoint: "nose", 
        posenetKey: "nose", 
        type: "point",
        defaultScale: 0.1,
        rotation: 0,
        offsetX: 0,
        offsetY: 0
      },
      { 
        name: "leftShoulder", 
        keypoint: "leftShoulder", 
        posenetKey: "leftShoulder", 
        type: "area",
        defaultScale: 0.3,
        rotation: 0,
        offsetX: 0.05,
        offsetY: -0.05
      },
      { 
        name: "rightShoulder", 
        keypoint: "rightShoulder", 
        posenetKey: "rightShoulder", 
        type: "area",
        defaultScale: 0.3,
        rotation: 0,
        offsetX: -0.05,
        offsetY: -0.05
      },
      { 
        name: "leftElbow", 
        keypoint: "leftElbow", 
        posenetKey: "leftElbow", 
        type: "point",
        defaultScale: 0.25,
        rotation: Math.PI/4,
        offsetX: 0.08,
        offsetY: 0.02
      },
      { 
        name: "rightElbow", 
        keypoint: "rightElbow", 
        posenetKey: "rightElbow", 
        type: "point",
        defaultScale: 0.25,
        rotation: -Math.PI/4,
        offsetX: -0.08,
        offsetY: 0.02
      },
      { 
        name: "leftWrist", 
        keypoint: "leftWrist", 
        posenetKey: "leftWrist", 
        type: "point",
        defaultScale: 0.2,
        rotation: Math.PI/2,
        offsetX: 0.1,
        offsetY: 0.05
      },
      { 
        name: "rightWrist", 
        keypoint: "rightWrist", 
        posenetKey: "rightWrist", 
        type: "point",
        defaultScale: 0.2,
        rotation: -Math.PI/2,
        offsetX: -0.1,
        offsetY: 0.05
      },
      { 
        name: "leftHip", 
        keypoint: "leftHip", 
        posenetKey: "leftHip", 
        type: "area",
        defaultScale: 0.3,
        rotation: 0,
        offsetX: 0.04,
        offsetY: -0.08
      },
      { 
        name: "rightHip", 
        keypoint: "rightHip", 
        posenetKey: "rightHip", 
        type: "area",
        defaultScale: 0.3,
        rotation: 0,
        offsetX: -0.04,
        offsetY: -0.08
      },
      { 
        name: "leftKnee", 
        keypoint: "leftKnee", 
        posenetKey: "leftKnee", 
        type: "point",
        defaultScale: 0.25,
        rotation: Math.PI/6,
        offsetX: 0.06,
        offsetY: 0
      },
      { 
        name: "rightKnee", 
        keypoint: "rightKnee", 
        posenetKey: "rightKnee", 
        type: "point",
        defaultScale: 0.25,
        rotation: -Math.PI/6,
        offsetX: -0.06,
        offsetY: 0
      },
      { 
        name: "leftAnkle", 
        keypoint: "leftAnkle", 
        posenetKey: "leftAnkle", 
        type: "point",
        defaultScale: 0.2,
        rotation: Math.PI/3,
        offsetX: 0.05,
        offsetY: 0.03
      },
      { 
        name: "rightAnkle", 
        keypoint: "rightAnkle", 
        posenetKey: "rightAnkle", 
        type: "point",
        defaultScale: 0.2,
        rotation: -Math.PI/3,
        offsetX: -0.05,
        offsetY: 0.03
      }
    ];

    // –¢–Ü–õ–¨–ö–ò 2 –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è
    const TATTOO_NAMES = ["rose", "skull"];

    let currentTattoo = null;
    let tattooX = 0.5, tattooY = 0.5; // –ü–æ—á–∞—Ç–∫–æ–≤—ñ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –ø–æ —Ü–µ–Ω—Ç—Ä—É
    let tattooScale = 0.3;
    let tattooAngle = 0;
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let selectedBodyPart = BODY_PARTS[5]; // leftWrist –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    let activeTouches = {};
    let manualMode = true; // –°–ø–æ—á–∞—Ç–∫—É —Ä—É—á–Ω–∏–π —Ä–µ–∂–∏–º, –ø–æ–∫–∏ –Ω–µ –≤–∏—è–≤–∏–º–æ –ø–æ–∑—É
    let initialDistance = 0;
    let initialScale = 0.3;
    let lastPose = null;
    let isInitialized = false;

    // === DOM ===
    const video = document.getElementById("video");
    const overlayCanvas = document.getElementById("overlayCanvas");
    const ctx = overlayCanvas.getContext("2d");
    const loading = document.getElementById("loading");
    const tattooPicker = document.getElementById("tattooPicker");
    const uploadBtn = document.getElementById("uploadBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    const bodyPartPanel = document.getElementById("bodyPartPanel");
    const langToggle = document.getElementById("langToggle");
    const manualIndicator = document.getElementById("manualIndicator");
    const debugInfo = document.getElementById("debugInfo");
    const debugToggle = document.getElementById("debugToggle");

    // === –§—É–Ω–∫—Ü—ñ—ó –º–æ–≤ ===
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.title = LANGUAGES[lang].title;
      document.getElementById('loading').innerHTML = LANGUAGES[lang].loading;
      document.getElementById('captureBtn').textContent = LANGUAGES[lang].capture;
      document.getElementById('uploadBtn').textContent = LANGUAGES[lang].upload;
      document.getElementById('debugToggle').textContent = LANGUAGES[lang].debug;
      document.getElementById('manualIndicator').textContent = LANGUAGES[lang].manualMode;
      document.getElementById('langToggle').textContent = lang === 'uk' ? 'üá¨üáß' : 'üá∫üá¶';
      buildBodyPartSelector();
    }

    function updateManualIndicator() {
      manualIndicator.style.display = manualMode ? 'block' : 'none';
    }

    function updateDebugInfo() {
      if (!debugMode) {
        debugInfo.style.display = 'none';
        return;
      }
      
      debugInfo.style.display = 'block';
      let debugText = `Tattoo: ${tattooX.toFixed(2)}, ${tattooY.toFixed(2)}<br>`;
      debugText += `Scale: ${tattooScale.toFixed(2)}<br>`;
      debugText += `Angle: ${tattooAngle.toFixed(2)}<br>`;
      debugText += `Manual: ${manualMode}<br>`;
      debugText += `Initialized: ${isInitialized}<br>`;
      
      if (lastPose) {
        const part = selectedBodyPart;
        debugText += `Selected: ${part.name}<br>`;
        
        if (lastPose[part.posenetKey]) {
          const kp = lastPose[part.posenetKey];
          debugText += `Keypoint: x:${kp.x.toFixed(0)}, y:${kp.y.toFixed(0)}, score:${kp.score.toFixed(2)}`;
        } else {
          debugText += `Keypoint: NOT FOUND`;
        }
      }
      
      debugInfo.innerHTML = debugText;
    }

    function triggerHapticFeedback() {
      if (navigator.vibrate) navigator.vibrate(10);
    }

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É ===
    function resizeCanvas() {
      overlayCanvas.width = video.videoWidth || window.innerWidth;
      overlayCanvas.height = video.videoHeight || window.innerHeight;
      
      // –ü—ñ—Å–ª—è —Ä–µ—Å–∞–π–∑—É –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
      if (!isInitialized) {
        tattooX = 0.5;
        tattooY = 0.5;
      }
      redrawTattoo();
    }

    function buildTattooPicker() {
      tattooPicker.innerHTML = "";
      TATTOO_NAMES.forEach(name => {
        const img = document.createElement("img");
        img.className = "tattoo-thumb";
        img.src = `tattoos/${name}.png`;
        img.onclick = () => {
          triggerHapticFeedback();
          loadTattooImage(`tattoos/${name}.png`);
          document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
          img.classList.add('selected');
        };
        tattooPicker.appendChild(img);
      });
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ø–µ—Ä—à–µ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è
      if (TATTOO_NAMES.length > 0) {
        tattooPicker.children[0]?.classList.add('selected');
        loadTattooImage(`tattoos/${TATTOO_NAMES[0]}.png`);
      }
    }

    function loadTattooImage(src) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        currentTattoo = img;
        // –ü—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è –∑–∞–ª–∏—à–∞—î–º–æ –π–æ–≥–æ –ø–æ —Ü–µ–Ω—Ç—Ä—É
        if (!isInitialized) {
          tattooX = 0.5;
          tattooY = 0.5;
        }
        redrawTattoo();
      };
      img.onerror = () => {
        console.warn("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è:", src);
        createFallbackTattoo();
      };
      img.src = src;
    }

    function createFallbackTattoo() {
      const canvas = document.createElement('canvas');
      canvas.width = 200;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      
      // –°—Ç–≤–æ—Ä—é—î–º–æ –ø—Ä–æ—Å—Ç–µ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è-–∑–∞–≥–ª—É—à–∫—É
      ctx.fillStyle = '#FFD700';
      ctx.beginPath();
      ctx.arc(100, 100, 60, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = '#000';
      ctx.font = 'bold 24px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('TAT', 100, 100);
      
      const img = new Image();
      img.onload = () => {
        currentTattoo = img;
        tattooX = 0.5;
        tattooY = 0.5;
        redrawTattoo();
      };
      img.src = canvas.toDataURL();
    }

    function buildBodyPartSelector() {
      bodyPartPanel.innerHTML = "";
      BODY_PARTS.forEach(part => {
        const btn = document.createElement("button");
        btn.className = "body-part-btn";
        btn.textContent = LANGUAGES[currentLang].bodyParts[part.name] || part.name;
        btn.onclick = () => {
          triggerHapticFeedback();
          selectedBodyPart = part;
          // –ü—Ä–∏ –∑–º—ñ–Ω—ñ —á–∞—Å—Ç–∏–Ω–∏ —Ç—ñ–ª–∞ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —Ä–µ–∂–∏–º
          manualMode = false;
          updateManualIndicator();
          document.querySelectorAll('.body-part-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          redrawTattoo();
        };
        if (part === selectedBodyPart) btn.classList.add('active');
        bodyPartPanel.appendChild(btn);
      });
    }

    // === –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è ===
    function redrawTattoo() {
      if (!currentTattoo) return;
      
      ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      
      // –ú–∞–ª—é—î–º–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è
      const w = overlayCanvas.width * tattooScale;
      const h = (currentTattoo.height / currentTattoo.width) * w;
      
      ctx.save();
      ctx.translate(overlayCanvas.width * tattooX, overlayCanvas.height * tattooY);
      ctx.rotate(tattooAngle);
      ctx.globalAlpha = 0.9;
      ctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
      ctx.restore();

      // –î–æ–¥–∞—î–º–æ –≤—ñ–¥–ª–∞–≥–æ–¥–∂—É–≤–∞–ª—å–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
      if (debugMode && lastPose) {
        drawDebugInfo();
      }
    }

    function drawDebugInfo() {
      ctx.save();
      ctx.strokeStyle = 'lime';
      ctx.fillStyle = 'lime';
      ctx.lineWidth = 2;
      ctx.font = '10px Arial';
      
      // –ú–∞–ª—é—î–º–æ –≤—Å—ñ –∫–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏
      Object.entries(lastPose).forEach(([key, kp]) => {
        if (kp && kp.score > 0.2) {
          ctx.beginPath();
          ctx.arc(kp.x, kp.y, 4, 0, Math.PI * 2);
          ctx.fill();
          
          // –ü—ñ–¥–ø–∏—Å–∏ –¥–ª—è —Ç–æ—á–æ–∫
          ctx.fillText(key, kp.x + 8, kp.y - 8);
        }
      });
      
      // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –≤–∏–±—Ä–∞–Ω—É —Ç–æ—á–∫—É
      const selectedKp = lastPose[selectedBodyPart.posenetKey];
      if (selectedKp && selectedKp.score > 0.2) {
        ctx.strokeStyle = 'gold';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(selectedKp.x, selectedKp.y, 15, 0, Math.PI * 2);
        ctx.stroke();
        
        ctx.fillStyle = 'gold';
        ctx.font = '12px Arial';
        ctx.fillText(selectedBodyPart.name, selectedKp.x + 20, selectedKp.y - 12);
      }
      
      ctx.restore();
    }

    // === PoseNet –¥–µ—Ç–µ–∫—Ü—ñ—è ===
    async function detectPose() {
      if (!net) return;
      
      try {
        const pose = await net.estimateSinglePose(video, {
          flipHorizontal: false,
          decodingMethod: 'single-person'
        });

        if (pose && pose.keypoints) {
          const keypointMap = {};
          pose.keypoints.forEach(kp => {
            keypointMap[kp.part] = {
              x: kp.position.x,
              y: kp.position.y,
              score: kp.score
            };
          });

          lastPose = keypointMap;
          
          // –Ø–∫—â–æ –∑–Ω–∞–π—à–ª–∏ –ø–æ–∑—É —ñ –Ω–µ –≤ —Ä—É—á–Ω–æ–º—É —Ä–µ–∂–∏–º—ñ - –ø—Ä–∏–∫—Ä—ñ–ø–ª—é—î–º–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è
          if (!manualMode) {
            attachTattooToBody(keypointMap);
          }
          
          if (!isInitialized) {
            isInitialized = true;
            console.log("Pose detection initialized successfully");
          }
        } else {
          lastPose = null;
        }
      } catch (error) {
        console.error("Pose detection error:", error);
        lastPose = null;
      }
      
      updateDebugInfo();
      requestAnimationFrame(detectPose);
    }

    function attachTattooToBody(keypoints) {
      if (!currentTattoo || manualMode) return;
      
      const part = selectedBodyPart;
      const kp = keypoints[part.posenetKey];
      
      if (kp && kp.score > 0.3) {
        // –ö–æ—Ä–µ–∫—Ç–Ω–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
        const targetX = kp.x / overlayCanvas.width;
        const targetY = kp.y / overlayCanvas.height;
        
        let scale = part.defaultScale;
        const rotation = part.rotation;
        
        // –î–∏–Ω–∞–º—ñ—á–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä—ñ–≤ —Ç—ñ–ª–∞
        if (keypoints.leftShoulder && keypoints.rightShoulder && 
            keypoints.leftShoulder.score > 0.3 && keypoints.rightShoulder.score > 0.3) {
          const shoulderWidth = Math.abs(keypoints.leftShoulder.x - keypoints.rightShoulder.x);
          scale = Math.max(0.1, Math.min(0.8, shoulderWidth / overlayCanvas.width * 1.5));
        }
        
        // –ü–ª–∞–≤–Ω–∞ —ñ–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü—ñ—è
        const smoothFactor = 0.3;
        tattooX = (1 - smoothFactor) * tattooX + smoothFactor * targetX;
        tattooY = (1 - smoothFactor) * tattooY + smoothFactor * targetY;
        tattooScale = (1 - smoothFactor) * tattooScale + smoothFactor * scale;
        tattooAngle = (1 - smoothFactor) * tattooAngle + smoothFactor * rotation;
        
        redrawTattoo();
      }
    }

    // === –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π ===
    langToggle.onclick = () => {
      triggerHapticFeedback();
      setLanguage(currentLang === 'uk' ? 'en' : 'uk');
    };

    debugToggle.onclick = () => {
      triggerHapticFeedback();
      debugMode = !debugMode;
      updateDebugInfo();
      redrawTattoo();
    };

    uploadBtn.onclick = () => {
      triggerHapticFeedback();
      fileInput.click();
    };

    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type === "image/png") {
        const url = URL.createObjectURL(file);
        loadTattooImage(url);
        document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
        manualMode = true;
        updateManualIndicator();
      }
    };

    captureBtn.onclick = () => {
      triggerHapticFeedback();
      const captureCanvas = document.createElement("canvas");
      captureCanvas.width = overlayCanvas.width;
      captureCanvas.height = overlayCanvas.height;
      const cctx = captureCanvas.getContext("2d");
      
      // –ú–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ (–¥–∑–µ—Ä–∫–∞–ª—å–Ω–æ)
      cctx.save();
      cctx.translate(captureCanvas.width, 0);
      cctx.scale(-1, 1);
      cctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
      cctx.restore();
      
      // –ú–∞–ª—é—î–º–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è
      if (currentTattoo) {
        const w = captureCanvas.width * tattooScale;
        const h = (currentTattoo.height / currentTattoo.width) * w;
        cctx.save();
        cctx.translate(captureCanvas.width * tattooX, captureCanvas.height * tattooY);
        cctx.rotate(tattooAngle);
        cctx.globalAlpha = 0.9;
        cctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
        cctx.restore();
      }
      
      const link = document.createElement("a");
      link.download = "tattoo-preview.png";
      link.href = captureCanvas.toDataURL("image/png");
      link.click();
    };

    // === –û–±—Ä–æ–±–∫–∞ —Ç–æ—Ä–∫–∞–Ω—å ===
    overlayCanvas.addEventListener("touchstart", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { 
          x: touches[i].clientX, 
          y: touches[i].clientY 
        };
      }

      if (touches.length === 1) {
        const rect = overlayCanvas.getBoundingClientRect();
        const touchX = touches[0].clientX;
        const touchY = touches[0].clientY;
        
        const xOnCanvas = (touchX - rect.left) / rect.width;
        const yOnCanvas = (touchY - rect.top) / rect.height;
        
        const dx = xOnCanvas - tattooX;
        const dy = yOnCanvas - tattooY;
        const distanceFromCenter = Math.hypot(dx, dy);
        
        if (distanceFromCenter < tattooScale * 0.8) {
          isDragging = true;
          dragOffsetX = touchX - overlayCanvas.width * tattooX;
          dragOffsetY = touchY - overlayCanvas.height * tattooY;
          manualMode = true;
          updateManualIndicator();
          triggerHapticFeedback();
        }
      } else if (touches.length === 2) {
        const t1 = touches[0];
        const t2 = touches[1];
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        initialDistance = Math.sqrt(dx * dx + dy * dy);
        initialScale = tattooScale;
        manualMode = true;
        updateManualIndicator();
        triggerHapticFeedback();
      }
    });

    overlayCanvas.addEventListener("touchmove", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { 
          x: touches[i].clientX, 
          y: touches[i].clientY 
        };
      }

      if (touches.length === 1 && isDragging) {
        const touch = touches[0];
        tattooX = (touch.clientX - dragOffsetX) / overlayCanvas.width;
        tattooY = (touch.clientY - dragOffsetY) / overlayCanvas.height;
        redrawTattoo();
      } else if (touches.length === 2) {
        const t1 = touches[0];
        const t2 = touches[1];
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        const currentDistance = Math.sqrt(dx * dx + dy * dy);
        
        if (initialDistance > 0) {
          const scaleFactor = currentDistance / initialDistance;
          tattooScale = Math.max(0.1, Math.min(2.0, initialScale * scaleFactor));
          redrawTattoo();
        }
      }
    });

    overlayCanvas.addEventListener("touchend", (e) => {
      if (!currentTattoo) return;
      for (let i = 0; i < e.changedTouches.length; i++) {
        delete activeTouches[e.changedTouches[i].identifier];
      }
      
      if (e.touches.length === 0) {
        isDragging = false;
        initialDistance = 0;
      }
    });

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è PoseNet ===
    async function initPose() {
      try {
        loading.innerHTML = "üîÑ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª—ñ —Ç—Ä–µ–∫—ñ–Ω–≥—É...";
        net = await posenet.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          inputResolution: 257,
          multiplier: 0.75
        });
        console.log("PoseNet model loaded successfully");
      } catch (error) {
        console.error("Error loading PoseNet:", error);
        throw error;
      }
    }

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        });
        video.srcObject = stream;
        
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve).catch(reject);
          };
          video.onerror = reject;
        });
        
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
        loading.style.display = "none";
      } catch (error) {
        console.error("Camera error:", error);
        throw error;
      }
    }

    // === –°—Ç–∞—Ä—Ç –¥–æ–¥–∞—Ç–∫—É ===
    async function initializeApp() {
      try {
        buildTattooPicker();
        buildBodyPartSelector();
        setLanguage('uk');
        updateManualIndicator(); // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä—É—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
        
        await initPose();
        await setupCamera();
        
        // –°–ø–æ—á–∞—Ç–∫—É –ø–æ–∫–∞–∑—É—î–º–æ —Ç–∞—Ç—É—é–≤–∞–Ω–Ω—è –ø–æ —Ü–µ–Ω—Ç—Ä—É
        redrawTattoo();
        
        // –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–µ—Ç–µ–∫—Ü—ñ—é –ø–æ–∑–∏
        detectPose();
      } catch (err) {
        console.error("Init error:", err);
        const errorMsg = currentLang === 'en' 
          ? "‚ùå Failed to start<br><small>Try Chrome/Safari on mobile</small>"
          : "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É<br><small>–°–ø—Ä–æ–±—É–π—Ç–µ Chrome/Safari –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É</small>";
        loading.innerHTML = errorMsg;
      }
    }

    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –¥–æ–¥–∞—Ç–æ–∫
    initializeApp();
  </script>
</body>
</html>
