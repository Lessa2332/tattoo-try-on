<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Tattoo Try-On AR</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: white;
      touch-action: none;
      -webkit-text-size-adjust: 100%;
    }
    #video, #overlayCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    #video { z-index: 1; }
    #overlayCanvas { 
      z-index: 2; 
      pointer-events: auto;
      touch-action: pan-x pan-y pinch-zoom;
    }

    /* –Ü–Ω—à—ñ —Å—Ç–∏–ª—ñ –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏ */
    #langToggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    #bodyPartPanel {
      position: fixed;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #bodyPartPanel::-webkit-scrollbar { display: none; }

    .body-part-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 16px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 80px;
      text-align: center;
    }
    .body-part-btn.active {
      background: gold;
      color: #000;
      font-weight: bold;
    }

    .panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 12px;
      border-radius: 24px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
    }
    .panel::-webkit-scrollbar { display: none; }

    .btn {
      padding: 12px 16px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 20px;
      color: white;
      font-size: 15px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
      text-align: center;
    }

    #tattooPicker {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
    }
    #tattooPicker::-webkit-scrollbar { display: none; }

    .tattoo-thumb {
      width: 60px; height: 60px;
      border: 2px solid white;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      object-fit: contain;
    }
    .tattoo-thumb.selected { 
      border-color: gold; 
      box-shadow: 0 0 0 2px gold;
    }

    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 999;
      color: white; font-size: 18px;
      padding: 20px;
      text-align: center;
    }
    #loading p { margin-top: 16px; font-size: 14px; color: #aaa; }

    #manualIndicator {
      position: fixed;
      top: 12px;
      left: 12px;
      background: rgba(255,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      z-index: 100;
      display: none;
    }
  </style>
</head>
<body>
  <div id="loading">
    üîç Loading camera and pose detection...<br>
    <p>Please allow camera access</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="overlayCanvas"></canvas>

  <button id="langToggle">üá∫üá¶</button>
  <div id="manualIndicator">Manual Mode</div>

  <div id="tattooPicker"></div>
  <div id="bodyPartPanel"></div>

  <div class="panel">
    <button id="captureBtn" class="btn">üì∏ Capture</button>
    <button id="uploadBtn" class="btn">‚ûï Upload PNG</button>
  </div>

  <input type="file" id="fileInput" accept="image/png" style="display:none" />

  <!-- PoseNet –∑–∞–º—ñ—Å—Ç—å BodyPix -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet@2.2.2"></script>

  <script>
    // === –ú–æ–≤–∏ ===
    const LANGUAGES = {
      en: {
        title: "Tattoo Try-On AR",
        loading: "üîç Loading camera and pose detection...<br><p>Please allow camera access</p>",
        capture: "üì∏ Capture",
        upload: "‚ûï Upload PNG",
        manualMode: "Manual Mode",
        bodyParts: {
          "Left Shoulder": "Left Shoulder",
          "Right Shoulder": "Right Shoulder", 
          "Left Elbow": "Left Elbow",
          "Right Elbow": "Right Elbow",
          "Left Wrist": "Left Wrist",
          "Right Wrist": "Right Wrist",
          "Left Hip": "Left Hip",
          "Right Hip": "Right Hip",
          "Left Knee": "Left Knee",
          "Right Knee": "Right Knee",
          "Left Ankle": "Left Ankle",
          "Right Ankle": "Right Ankle"
        }
      },
      uk: {
        title: "AR –ü—Ä–∏–º—ñ—Ä–∫–∞ —Ç–∞—Ç—É",
        loading: "üîç –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏ —Ç–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É...<br><p>–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>",
        capture: "üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ",
        upload: "‚ûï –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG",
        manualMode: "–†—É—á–Ω–∏–π —Ä–µ–∂–∏–º",
        bodyParts: {
          "Left Shoulder": "–õ—ñ–≤–µ –ø–ª–µ—á–µ",
          "Right Shoulder": "–ü—Ä–∞–≤–µ –ø–ª–µ—á–µ",
          "Left Elbow": "–õ—ñ–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "Right Elbow": "–ü—Ä–∞–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "Left Wrist": "–õ—ñ–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "Right Wrist": "–ü—Ä–∞–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "Left Hip": "–õ—ñ–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "Right Hip": "–ü—Ä–∞–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "Left Knee": "–õ—ñ–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "Right Knee": "–ü—Ä–∞–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "Left Ankle": "–õ—ñ–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞",
          "Right Ankle": "–ü—Ä–∞–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞"
        }
      }
    };

    let currentLang = 'en';
    let net = null;

    // === –ö–æ–Ω—Ñ—ñ–≥ ===
    const TATTOO_NAMES = ["skull", "rose"];

    const BODY_PARTS = [
      { name: "Left Shoulder", keypoint: "leftShoulder", type: "point" },
      { name: "Right Shoulder", keypoint: "rightShoulder", type: "point" },
      { name: "Left Elbow", keypoint: "leftElbow", type: "point" },
      { name: "Right Elbow", keypoint: "rightElbow", type: "point" },
      { name: "Left Wrist", keypoint: "leftWrist", type: "point" },
      { name: "Right Wrist", keypoint: "rightWrist", type: "point" },
      { name: "Left Hip", keypoint: "leftHip", type: "point" },
      { name: "Right Hip", keypoint: "rightHip", type: "point" },
      { name: "Left Knee", keypoint: "leftKnee", type: "point" },
      { name: "Right Knee", keypoint: "rightKnee", type: "point" },
      { name: "Left Ankle", keypoint: "leftAnkle", type: "point" },
      { name: "Right Ankle", keypoint: "rightAnkle", type: "point" }
    ];

    let currentTattoo = null;
    let tattooX = 0.5, tattooY = 0.5;
    let tattooScale = 0.3;
    let tattooAngle = 0;
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let selectedBodyPart = BODY_PARTS[4];
    let activeTouches = {};
    let manualMode = false;
    let initialDistance = 0;
    let initialScale = 0.3;

    // === DOM ===
    const video = document.getElementById("video");
    const overlayCanvas = document.getElementById("overlayCanvas");
    const ctx = overlayCanvas.getContext("2d");
    const loading = document.getElementById("loading");
    const tattooPicker = document.getElementById("tattooPicker");
    const uploadBtn = document.getElementById("uploadBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    const bodyPartPanel = document.getElementById("bodyPartPanel");
    const langToggle = document.getElementById("langToggle");
    const manualIndicator = document.getElementById("manualIndicator");

    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.title = LANGUAGES[lang].title;
      document.getElementById('loading').innerHTML = LANGUAGES[lang].loading;
      document.getElementById('captureBtn').textContent = LANGUAGES[lang].capture;
      document.getElementById('uploadBtn').textContent = LANGUAGES[lang].upload;
      document.getElementById('manualIndicator').textContent = LANGUAGES[lang].manualMode;
      document.getElementById('langToggle').textContent = lang === 'en' ? 'üá∫üá¶' : 'üá¨üáß';
      buildBodyPartSelector();
    }

    function updateManualIndicator() {
      manualIndicator.style.display = manualMode ? 'block' : 'none';
    }

    langToggle.onclick = () => {
      if (navigator.vibrate) navigator.vibrate(10);
      setLanguage(currentLang === 'en' ? 'uk' : 'en');
    };

    function resizeCanvas() {
      overlayCanvas.width = video.videoWidth || window.innerWidth;
      overlayCanvas.height = video.videoHeight || window.innerHeight;
      redrawTattoo();
    }

    function buildTattooPicker() {
      tattooPicker.innerHTML = "";
      TATTOO_NAMES.forEach(name => {
        const img = document.createElement("img");
        img.className = "tattoo-thumb";
        img.src = `tattoos/${name}.png`;
        img.onclick = () => {
          loadTattooImage(`tattoos/${name}.png`);
          document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
          img.classList.add('selected');
        };
        tattooPicker.appendChild(img);
      });
      if (TATTOO_NAMES.length > 0) {
        tattooPicker.children[0]?.classList.add('selected');
        loadTattooImage(`tattoos/${TATTOO_NAMES[0]}.png`);
      }
    }

    function loadTattooImage(src) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        currentTattoo = img;
        manualMode = false;
        updateManualIndicator();
        redrawTattoo();
      };
      img.onerror = () => {
        console.error("Failed to load tattoo:", src);
        createFallbackTattoo();
      };
      img.src = src;
    }

    function createFallbackTattoo() {
      const canvas = document.createElement('canvas');
      canvas.width = 200;
      canvas.height = 200;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = 'white';
      ctx.beginPath();
      ctx.arc(100, 100, 80, 0, Math.PI * 2);
      ctx.fill();
      
      ctx.fillStyle = 'black';
      ctx.beginPath();
      ctx.arc(100, 100, 60, 0, Math.PI * 2);
      ctx.fill();
      
      const img = new Image();
      img.onload = () => {
        currentTattoo = img;
        manualMode = false;
        updateManualIndicator();
        redrawTattoo();
      };
      img.src = canvas.toDataURL();
    }

    function buildBodyPartSelector() {
      bodyPartPanel.innerHTML = "";
      BODY_PARTS.forEach(part => {
        const btn = document.createElement("button");
        btn.className = "body-part-btn";
        btn.textContent = LANGUAGES[currentLang].bodyParts[part.name] || part.name;
        btn.onclick = () => {
          selectedBodyPart = part;
          manualMode = false;
          updateManualIndicator();
          document.querySelectorAll('.body-part-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        if (part === selectedBodyPart) btn.classList.add('active');
        bodyPartPanel.appendChild(btn);
      });
    }

    function redrawTattoo() {
      if (!currentTattoo) return;
      ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      const w = overlayCanvas.width * tattooScale;
      const h = (currentTattoo.height / currentTattoo.width) * w;
      ctx.save();
      ctx.translate(overlayCanvas.width * tattooX, overlayCanvas.height * tattooY);
      ctx.rotate(tattooAngle);
      ctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
      ctx.restore();
    }

    async function detectPose() {
      if (!net || manualMode) return;
      
      try {
        // PoseNet –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î estimateSinglePose –∞–±–æ estimateMultiplePoses
        const pose = await net.estimateSinglePose(video, {
          flipHorizontal: false,
          decodingMethod: 'single-person'
        });

        if (pose && pose.keypoints) {
          const keypointMap = {};
          
          pose.keypoints.forEach(kp => {
            keypointMap[kp.part] = {
              x: kp.position.x,
              y: kp.position.y,
              score: kp.score
            };
          });

          attachTattooToBody(keypointMap);
        }
      } catch (error) {
        console.error("Pose detection error:", error);
      }
      
      requestAnimationFrame(detectPose);
    }

    function attachTattooToBody(keypoints) {
      if (!currentTattoo || manualMode) return;
      
      const part = selectedBodyPart;
      const kp = keypoints[part.keypoint];
      
      if (kp && kp.score > 0.5) {
        const x = kp.x / overlayCanvas.width;
        const y = kp.y / overlayCanvas.height;
        
        tattooX = 0.7 * tattooX + 0.3 * x;
        tattooY = 0.7 * tattooY + 0.3 * y;
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–æ–∑–º—ñ—Ä—É —Ç—ñ–ª–∞
        if (keypoints.leftShoulder && keypoints.rightShoulder) {
          const shoulderWidth = Math.abs(keypoints.leftShoulder.x - keypoints.rightShoulder.x);
          const newScale = Math.max(0.2, Math.min(0.6, shoulderWidth / overlayCanvas.width * 1.5));
          tattooScale = 0.8 * tattooScale + 0.2 * newScale;
        }
        
        redrawTattoo();
      }
    }

    // –Ü–Ω—à—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–∏–º–∏
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type === "image/png") {
        const url = URL.createObjectURL(file);
        loadTattooImage(url);
        document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
        manualMode = true;
        updateManualIndicator();
      }
    };

    captureBtn.onclick = () => {
      const captureCanvas = document.createElement("canvas");
      captureCanvas.width = overlayCanvas.width;
      captureCanvas.height = overlayCanvas.height;
      const cctx = captureCanvas.getContext("2d");
      cctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
      if (currentTattoo) {
        const w = captureCanvas.width * tattooScale;
        const h = (currentTattoo.height / currentTattoo.width) * w;
        cctx.save();
        cctx.translate(captureCanvas.width * tattooX, captureCanvas.height * tattooY);
        cctx.rotate(tattooAngle);
        cctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
        cctx.restore();
      }
      const link = document.createElement("a");
      link.download = "tattoo-preview.png";
      link.href = captureCanvas.toDataURL("image/png");
      link.click();
    };

    // –û–±—Ä–æ–±–∫–∞ —Ç–æ—Ä–∫–∞–Ω—å –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–∑–º—ñ–Ω–Ω–æ—é
    overlayCanvas.addEventListener("touchstart", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { 
          x: touches[i].clientX, 
          y: touches[i].clientY 
        };
      }

      if (touches.length === 1) {
        const rect = overlayCanvas.getBoundingClientRect();
        const touchX = touches[0].clientX;
        const touchY = touches[0].clientY;
        
        const xOnCanvas = (touchX - rect.left) / rect.width;
        const yOnCanvas = (touchY - rect.top) / rect.height;
        
        const dx = xOnCanvas - tattooX;
        const dy = yOnCanvas - tattooY;
        const distanceFromCenter = Math.hypot(dx, dy);
        
        if (distanceFromCenter < tattooScale * 0.8) {
          isDragging = true;
          dragOffsetX = touchX - overlayCanvas.width * tattooX;
          dragOffsetY = touchY - overlayCanvas.height * tattooY;
          manualMode = true;
          updateManualIndicator();
        }
      } else if (touches.length === 2) {
        const t1 = touches[0];
        const t2 = touches[1];
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        initialDistance = Math.sqrt(dx * dx + dy * dy);
        initialScale = tattooScale;
        manualMode = true;
        updateManualIndicator();
      }
    });

    overlayCanvas.addEventListener("touchmove", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { 
          x: touches[i].clientX, 
          y: touches[i].clientY 
        };
      }

      if (touches.length === 1 && isDragging) {
        const touch = touches[0];
        tattooX = (touch.clientX - dragOffsetX) / overlayCanvas.width;
        tattooY = (touch.clientY - dragOffsetY) / overlayCanvas.height;
        redrawTattoo();
      } else if (touches.length === 2) {
        const t1 = touches[0];
        const t2 = touches[1];
        const dx = t1.clientX - t2.clientX;
        const dy = t1.clientY - t2.clientY;
        const currentDistance = Math.sqrt(dx * dx + dy * dy);
        
        if (initialDistance > 0) {
          const scaleFactor = currentDistance / initialDistance;
          tattooScale = Math.max(0.1, Math.min(1.0, initialScale * scaleFactor));
          redrawTattoo();
        }
      }
    });

    overlayCanvas.addEventListener("touchend", (e) => {
      if (!currentTattoo) return;
      for (let i = 0; i < e.changedTouches.length; i++) {
        delete activeTouches[e.changedTouches[i].identifier];
      }
      
      if (e.touches.length === 0) {
        isDragging = false;
        initialDistance = 0;
      }
    });

    // === –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è PoseNet ===
    async function initPose() {
      try {
        loading.innerHTML = "üîÑ Loading pose detection model...";
        net = await posenet.load({
          architecture: 'MobileNetV1',
          outputStride: 16,
          inputResolution: 257,
          multiplier: 0.75
        });
        console.log("PoseNet model loaded successfully");
      } catch (error) {
        console.error("Error loading PoseNet:", error);
        throw error;
      }
    }

    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { 
            facingMode: "environment",
            width: { ideal: 640 },
            height: { ideal: 480 }
          }
        });
        video.srcObject = stream;
        
        await new Promise((resolve, reject) => {
          video.onloadedmetadata = () => {
            video.play().then(resolve).catch(reject);
          };
          video.onerror = reject;
        });
        
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
        loading.style.display = "none";
      } catch (error) {
        console.error("Camera error:", error);
        throw error;
      }
    }

    // === –°—Ç–∞—Ä—Ç ===
    async function initializeApp() {
      try {
        buildTattooPicker();
        buildBodyPartSelector();
        setLanguage('en');
        
        await initPose();
        await setupCamera();
        detectPose();
      } catch (err) {
        console.error("Init error:", err);
        const errorMsg = currentLang === 'en' 
          ? "‚ùå Failed to start<br><small>Try Chrome/Safari on mobile</small>"
          : "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É<br><small>–°–ø—Ä–æ–±—É–π—Ç–µ Chrome/Safari –Ω–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É</small>";
        loading.innerHTML = errorMsg;
      }
    }
    
    initializeApp();
  </script>
</body>
</html>
