<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Tattoo Try-On AR</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      overflow: hidden;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: white;
      touch-action: none;
    }
    #video, #canvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
    }
    #video { z-index: 1; }
    #canvas { z-index: 2; }

    #tattooOverlay {
      position: absolute;
      z-index: 3;
      pointer-events: auto; /* –≤–∞–∂–ª–∏–≤–æ –¥–ª—è –∂–µ—Å—Ç—ñ–≤ */
      image-rendering: -webkit-optimize-contrast;
      display: none;
    }

    /* UI */
    .panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 10px 14px;
      border-radius: 24px;
      backdrop-filter: blur(10px);
    }

    .btn {
      padding: 10px 16px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 20px;
      color: white;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn.active {
      background: gold;
      color: #000;
      font-weight: bold;
    }

    #tattooPicker {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .tattoo-thumb {
      width: 56px; height: 56px;
      border: 2px solid white;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      object-fit: contain;
    }
    .tattoo-thumb.selected { border-color: gold; box-shadow: 0 0 0 2px gold; }

    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 999;
      color: white; font-size: 18px;
    }
    #loading p { margin-top: 12px; font-size: 14px; color: #aaa; }
  </style>
</head>
<body>
  <div id="loading">
    üîç Loading camera and pose detection...<br>
    <p>Please allow camera access</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="canvas"></canvas>
  <img id="tattooOverlay" draggable="false" />

  <div id="tattooPicker"></div>

  <div class="panel">
    <button id="captureBtn" class="btn">üì∏ Capture</button>
    <button id="uploadBtn" class="btn">‚ûï Upload PNG</button>
  </div>

  <!-- Body part selector -->
  <div id="bodyPartPanel" class="panel" style="bottom: 160px; flex-wrap: wrap; max-width: 90vw;">
    <!-- –∑–∞–ø–æ–≤–Ω—é—î—Ç—å—Å—è JS -->
  </div>

  <input type="file" id="fileInput" accept="image/png" style="display:none" />

  <script type="module">
    // === CONFIG ===
    const TATTOO_NAMES = ["skull", "rose"]; // –¥–æ–¥–∞–π —Å–≤–æ—ó —Ñ–∞–π–ª–∏ –∑ /tattoos/

    // Body parts for tattoo placement (name, landmark index)
    const BODY_PARTS = [
      { name: "Left Shoulder", idx: 11 },
      { name: "Right Shoulder", idx: 12 },
      { name: "Left Elbow", idx: 13 },
      { name: "Right Elbow", idx: 14 },
      { name: "Left Wrist", idx: 15 },
      { name: "Right Wrist", idx: 16 },
      { name: "Left Hip", idx: 23 },
      { name: "Right Hip", idx: 24 },
      { name: "Left Knee", idx: 25 },
      { name: "Right Knee", idx: 26 },
      { name: "Left Ankle", idx: 27 },
      { name: "Right Ankle", idx: 28 }
    ];

    let currentTattoo = null;
    let tattooX = 0.5, tattooY = 0.5;
    let tattooScale = 0.3;
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let selectedBodyPart = BODY_PARTS[4]; // default: Left Wrist
    let activeTouches = {};

    // === DOM ===
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const tattooImg = document.getElementById("tattooOverlay");
    const loading = document.getElementById("loading");
    const tattooPicker = document.getElementById("tattooPicker");
    const uploadBtn = document.getElementById("uploadBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    const bodyPartPanel = document.getElementById("bodyPartPanel");

    // === Resize canvas ===
    function resizeCanvas() {
      canvas.width = video.videoWidth || window.innerWidth;
      canvas.height = video.videoHeight || window.innerHeight;
      updateTattooPosition();
    }

    // === Tattoo picker ===
    function buildTattooPicker() {
      tattooPicker.innerHTML = "";
      TATTOO_NAMES.forEach(name => {
        const img = document.createElement("img");
        img.className = "tattoo-thumb";
        img.src = `tattoos/${name}.png`;
        img.onclick = () => {
          loadTattooImage(`tattoos/${name}.png`);
          document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
          img.classList.add('selected');
        };
        tattooPicker.appendChild(img);
      });
      if (TATTOO_NAMES.length > 0) {
        tattooPicker.children[0]?.classList.add('selected');
        loadTattooImage(`tattoos/${TATTOO_NAMES[0]}.png`);
      }
    }

    function loadTattooImage(src) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        currentTattoo = img;
        tattooImg.src = src;
        tattooImg.style.display = "block";
        updateTattooPosition();
      };
      img.src = src;
    }

    // === Body part selector ===
    function buildBodyPartSelector() {
      bodyPartPanel.innerHTML = "";
      BODY_PARTS.forEach(part => {
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = part.name;
        btn.onclick = () => {
          selectedBodyPart = part;
          document.querySelectorAll('#bodyPartPanel .btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        if (part === selectedBodyPart) btn.classList.add('active');
        bodyPartPanel.appendChild(btn);
      });
    }

    // === Update tattoo position ===
    function updateTattooPosition() {
      if (!currentTattoo) return;
      const w = canvas.width * tattooScale;
      const h = (currentTattoo.height / currentTattoo.width) * w;
      tattooImg.style.width = `${w}px`;
      tattooImg.style.height = `${h}px`;
      tattooImg.style.left = `${canvas.width * tattooX - w / 2}px`;
      tattooImg.style.top = `${canvas.height * tattooY - h / 2}px`;
    }

    // === Attach tattoo to body part ===
    function attachTattooToBody(landmarks) {
      if (!landmarks || !currentTattoo) return;
      const point = landmarks[selectedBodyPart.idx];
      if (point && point.visibility > 0.6) {
        // Smooth movement
        tattooX = 0.7 * tattooX + 0.3 * point.x;
        tattooY = 0.7 * tattooY + 0.3 * point.y;
        updateTattooPosition();
      }
    }

    // === Upload ===
    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type === "image/png") {
        const url = URL.createObjectURL(file);
        loadTattooImage(url);
        document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
      }
    };

    // === Capture ===
    captureBtn.onclick = () => {
      resizeCanvas();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      if (currentTattoo) {
        const w = canvas.width * tattooScale;
        const h = (currentTattoo.height / currentTattoo.width) * w;
        const x = canvas.width * tattooX - w / 2;
        const y = canvas.height * tattooY - h / 2;
        ctx.drawImage(currentTattoo, x, y, w, h);
      }
      const link = document.createElement("a");
      link.download = "tattoo-preview.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    };

    // === Touch gestures: drag & pinch ===
    tattooImg.addEventListener("touchstart", (e) => {
      e.preventDefault();
      const touches = e.touches;
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = {
          x: touches[i].clientX,
          y: touches[i].clientY
        };
      }

      if (touches.length === 1) {
        const rect = tattooImg.getBoundingClientRect();
        dragOffsetX = touches[0].clientX - rect.left;
        dragOffsetY = touches[0].clientY - rect.top;
        isDragging = true;
      }
    });

    tattooImg.addEventListener("touchmove", (e) => {
      e.preventDefault();
      const touches = e.touches;

      // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ —Ç–æ—Ä–∫–∞–Ω–Ω—è
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = {
          x: touches[i].clientX,
          y: touches[i].clientY
        };
      }

      if (touches.length === 1 && isDragging) {
        const x = touches[0].clientX - dragOffsetX;
        const y = touches[0].clientY - dragOffsetY;
        tattooImg.style.left = `${x}px`;
        tattooImg.style.top = `${y}px`;
        tattooX = (x + tattooImg.offsetWidth / 2) / canvas.width;
        tattooY = (y + tattooImg.offsetHeight / 2) / canvas.height;
      } else if (touches.length === 2) {
        // Pinch to scale
        const t1 = activeTouches[touches[0].identifier];
        const t2 = activeTouches[touches[1].identifier];
        if (t1 && t2) {
          const dx = t1.x - t2.x;
          const dy = t1.y - t2.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          // –ú–∞—Å—à—Ç–∞–± –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–∏–π –≤—ñ–¥—Å—Ç–∞–Ω—ñ –º—ñ–∂ –ø–∞–ª—å—Ü—è–º–∏ (–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–æ —à–∏—Ä–∏–Ω–∏ –µ–∫—Ä–∞–Ω–∞)
          const newScale = Math.max(0.1, Math.min(1.0, distance / (canvas.width * 0.8)));
          tattooScale = newScale;
          updateTattooPosition();
        }
      }
    });

    tattooImg.addEventListener("touchend", (e) => {
      e.preventDefault();
      // –í–∏–¥–∞–ª—è—î–º–æ –∑–Ω–∏–∫–ª—ñ —Ç–æ—Ä–∫–∞–Ω–Ω—è
      for (let i = 0; i < e.changedTouches.length; i++) {
        delete activeTouches[e.changedTouches[i].identifier];
      }
      if (e.touches.length < 2) {
        isDragging = e.touches.length === 1;
      }
    });

    // === MediaPipe Pose ===
    import { PoseLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

    let poseLandmarker = null;

    async function initPose() {
      const filesetResolver = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
      );
      poseLandmarker = await PoseLandmarker.createFromOptions(filesetResolver, {
        baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.float16.tflite" },
        runningMode: "VIDEO",
        numPoses: 1
      });
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });
      video.srcObject = stream;
      await video.play();
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);
      loading.style.display = "none";
    }

    let lastVideoTime = -1;
    function detectPose() {
      if (video.currentTime !== lastVideoTime && poseLandmarker) {
        lastVideoTime = video.currentTime;
        const results = poseLandmarker.detectForVideo(video, performance.now());
        if (results.landmarks && results.landmarks.length > 0) {
          attachTattooToBody(results.landmarks[0]);
        }
      }
      requestAnimationFrame(detectPose);
    }

    // === Start ===
    buildTattooPicker();
    buildBodyPartSelector();
    Promise.all([setupCamera(), initPose()])
      .then(() => detectPose())
      .catch(err => {
        console.error("Init error:", err);
        loading.innerHTML = "‚ùå Camera or pose failed.<br><small>Try Chrome/Safari on mobile.</small>";
      });
  </script>
</body>
</html>
