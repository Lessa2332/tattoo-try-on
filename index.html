<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>Tattoo Try-On AR</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #000;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: white;
      touch-action: none;
    }
    #video {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #overlayCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 2;
      /* –í–ê–ñ–õ–ò–í–û: –¥–æ–∑–≤–æ–ª—è—î–º–æ –ø–æ–¥—ñ—ó –¥–æ—Ç–∏–∫—É –Ω–∞ canvas */
      pointer-events: auto;
      touch-action: none;
    }

    #langToggle {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      color: white;
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-weight: bold;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    #bodyPartPanel {
      position: fixed;
      bottom: 160px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #bodyPartPanel::-webkit-scrollbar { display: none; }

    .body-part-btn {
      padding: 8px 12px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 16px;
      color: white;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 80px;
      text-align: center;
    }
    .body-part-btn.active {
      background: gold;
      color: #000;
      font-weight: bold;
    }

    .panel {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 12px;
      border-radius: 24px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
    }

    .btn {
      padding: 12px 16px;
      background: rgba(255,255,255,0.2);
      border: 2px solid white;
      border-radius: 20px;
      color: white;
      font-size: 15px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 100px;
      text-align: center;
    }

    #tattooPicker {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 100;
      background: rgba(0,0,0,0.6);
      padding: 10px;
      border-radius: 20px;
      backdrop-filter: blur(10px);
      max-width: 90vw;
      overflow-x: auto;
    }

    .tattoo-thumb {
      width: 60px; height: 60px;
      border: 2px solid white;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      object-fit: contain;
    }
    .tattoo-thumb.selected { 
      border-color: gold; 
      box-shadow: 0 0 0 2px gold;
    }

    #loading {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #000; display: flex; flex-direction: column;
      align-items: center; justify-content: center; z-index: 999;
      color: white; font-size: 18px;
      padding: 20px;
      text-align: center;
    }
    #loading p { margin-top: 16px; font-size: 14px; color: #aaa; }
  </style>
</head>
<body>
  <div id="loading">
    üîç Loading camera and pose detection...<br>
    <p>Please allow camera access</p>
  </div>

  <video id="video" playsinline muted></video>
  <canvas id="overlayCanvas"></canvas>

  <button id="langToggle">üá∫üá¶</button>

  <div id="tattooPicker"></div>
  <div id="bodyPartPanel"></div>

  <div class="panel">
    <button id="captureBtn" class="btn">üì∏ Capture</button>
    <button id="uploadBtn" class="btn">‚ûï Upload PNG</button>
  </div>

  <input type="file" id="fileInput" accept="image/png" style="display:none" />

  <script type="module">
    const LANGUAGES = {
      en: {
        title: "Tattoo Try-On AR",
        loading: "üîç Loading camera and pose detection...<br><p>Please allow camera access</p>",
        capture: "üì∏ Capture",
        upload: "‚ûï Upload PNG",
        bodyParts: {
          "Left Shoulder": "Left Shoulder",
          "Right Shoulder": "Right Shoulder",
          "Left Elbow": "Left Elbow",
          "Right Elbow": "Right Elbow",
          "Left Wrist": "Left Wrist",
          "Right Wrist": "Right Wrist",
          "Left Hip": "Left Hip",
          "Right Hip": "Right Hip",
          "Left Knee": "Left Knee",
          "Right Knee": "Right Knee",
          "Left Ankle": "Left Ankle",
          "Right Ankle": "Right Ankle"
        }
      },
      uk: {
        title: "AR –ü—Ä–∏–º—ñ—Ä–∫–∞ —Ç–∞—Ç—É",
        loading: "üîç –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞–º–µ—Ä–∏ —Ç–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É...<br><p>–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏</p>",
        capture: "üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ",
        upload: "‚ûï –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PNG",
        bodyParts: {
          "Left Shoulder": "–õ—ñ–≤–µ –ø–ª–µ—á–µ",
          "Right Shoulder": "–ü—Ä–∞–≤–µ –ø–ª–µ—á–µ",
          "Left Elbow": "–õ—ñ–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "Right Elbow": "–ü—Ä–∞–≤–∏–π –ª—ñ–∫–æ—Ç—å",
          "Left Wrist": "–õ—ñ–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "Right Wrist": "–ü—Ä–∞–≤–µ –∑–∞–ø'—è—Å—Ç—è",
          "Left Hip": "–õ—ñ–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "Right Hip": "–ü—Ä–∞–≤–µ —Å—Ç–µ–≥–Ω–æ",
          "Left Knee": "–õ—ñ–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "Right Knee": "–ü—Ä–∞–≤–µ –∫–æ–ª—ñ–Ω–æ",
          "Left Ankle": "–õ—ñ–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞",
          "Right Ankle": "–ü—Ä–∞–≤–∞ —â–∏–∫–æ–ª–æ—Ç–∫–∞"
        }
      }
    };

    let currentLang = 'en';
    function setLanguage(lang) {
      currentLang = lang;
      document.documentElement.lang = lang;
      document.title = LANGUAGES[lang].title;
      document.getElementById('loading').innerHTML = LANGUAGES[lang].loading;
      document.getElementById('captureBtn').textContent = LANGUAGES[lang].capture;
      document.getElementById('uploadBtn').textContent = LANGUAGES[lang].upload;
      document.getElementById('langToggle').textContent = lang === 'en' ? 'üá∫üá¶' : 'üá¨üáß';
      buildBodyPartSelector();
    }

    const TATTOO_NAMES = ["skull", "rose"];
    const BODY_PARTS = [
      { name: "Left Shoulder", idx: 11, type: "point" },
      { name: "Right Shoulder", idx: 12, type: "point" },
      { name: "Left Elbow", idx: 13, type: "vector", end: 15 },
      { name: "Right Elbow", idx: 14, type: "vector", end: 16 },
      { name: "Left Wrist", idx: 15, type: "vector", end: 19 },
      { name: "Right Wrist", idx: 16, type: "vector", end: 20 },
      { name: "Left Hip", idx: 23, type: "point" },
      { name: "Right Hip", idx: 24, type: "point" },
      { name: "Left Knee", idx: 25, type: "vector", end: 27 },
      { name: "Right Knee", idx: 26, type: "vector", end: 28 },
      { name: "Left Ankle", idx: 27, type: "vector", end: 31 },
      { name: "Right Ankle", idx: 28, type: "vector", end: 32 }
    ];

    let currentTattoo = null;
    let tattooX = 0.5, tattooY = 0.5;
    let tattooScale = 0.3;
    let tattooAngle = 0;
    let isDragging = false;
    let dragOffsetX = 0, dragOffsetY = 0;
    let selectedBodyPart = BODY_PARTS[4];
    let activeTouches = {};
    let manualMode = false;

    const video = document.getElementById("video");
    const overlayCanvas = document.getElementById("overlayCanvas");
    const ctx = overlayCanvas.getContext("2d");
    const loading = document.getElementById("loading");
    const tattooPicker = document.getElementById("tattooPicker");
    const uploadBtn = document.getElementById("uploadBtn");
    const captureBtn = document.getElementById("captureBtn");
    const fileInput = document.getElementById("fileInput");
    const bodyPartPanel = document.getElementById("bodyPartPanel");
    const langToggle = document.getElementById("langToggle");

    langToggle.onclick = () => setLanguage(currentLang === 'en' ? 'uk' : 'en');

    function resizeCanvas() {
      overlayCanvas.width = video.videoWidth || window.innerWidth;
      overlayCanvas.height = video.videoHeight || window.innerHeight;
      redrawTattoo();
    }

    function buildTattooPicker() {
      tattooPicker.innerHTML = "";
      TATTOO_NAMES.forEach(name => {
        const img = document.createElement("img");
        img.className = "tattoo-thumb";
        img.src = `tattoos/${name}.png`;
        img.onclick = () => {
          loadTattooImage(`tattoos/${name}.png`);
          document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
          img.classList.add('selected');
        };
        tattooPicker.appendChild(img);
      });
      if (TATTOO_NAMES.length > 0) {
        tattooPicker.children[0]?.classList.add('selected');
        loadTattooImage(`tattoos/${TATTOO_NAMES[0]}.png`);
      }
    }

    function loadTattooImage(src) {
      const img = new Image();
      img.crossOrigin = "anonymous";
      img.onload = () => {
        currentTattoo = img;
        manualMode = false;
        redrawTattoo();
      };
      img.src = src;
    }

    function buildBodyPartSelector() {
      bodyPartPanel.innerHTML = "";
      BODY_PARTS.forEach(part => {
        const btn = document.createElement("button");
        btn.className = "body-part-btn";
        btn.textContent = LANGUAGES[currentLang].bodyParts[part.name] || part.name;
        btn.onclick = () => {
          selectedBodyPart = part;
          manualMode = false;
          document.querySelectorAll('.body-part-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        };
        if (part === selectedBodyPart) btn.classList.add('active');
        bodyPartPanel.appendChild(btn);
      });
    }

    function redrawTattoo() {
      if (!currentTattoo) return;
      ctx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
      const w = overlayCanvas.width * tattooScale;
      const h = (currentTattoo.height / currentTattoo.width) * w;
      ctx.save();
      ctx.translate(overlayCanvas.width * tattooX, overlayCanvas.height * tattooY);
      ctx.rotate(tattooAngle);
      ctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
      ctx.restore();
    }

    function attachTattooToBody(landmarks) {
      if (!landmarks || !currentTattoo || manualMode) return;
      const part = selectedBodyPart;
      if (part.type === "point") {
        const pt = landmarks[part.idx];
        if (pt && pt.visibility > 0.6) {
          tattooX = 0.7 * tattooX + 0.3 * pt.x;
          tattooY = 0.7 * tattooY + 0.3 * pt.y;
          redrawTattoo();
        }
      } else if (part.type === "vector") {
        const start = landmarks[part.idx];
        const end = landmarks[part.end];
        if (!start || !end || start.visibility < 0.5 || end.visibility < 0.5) return;
        const mx = (start.x + end.x) / 2;
        const my = (start.y + end.y) / 2;
        const dx = end.x - start.x;
        const dy = end.y - start.y;
        const angle = Math.atan2(dy, dx);
        const dist = Math.hypot(dx, dy);
        const newScale = Math.max(0.1, Math.min(0.8, dist * 2.5));
        tattooX = 0.7 * tattooX + 0.3 * mx;
        tattooY = 0.7 * tattooY + 0.3 * my;
        tattooScale = 0.7 * tattooScale + 0.3 * newScale;
        tattooAngle = 0.7 * tattooAngle + 0.3 * angle;
        redrawTattoo();
      }
    }

    uploadBtn.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type === "image/png") {
        const url = URL.createObjectURL(file);
        loadTattooImage(url);
        document.querySelectorAll('.tattoo-thumb').forEach(t => t.classList.remove('selected'));
        manualMode = true;
      }
    };

    captureBtn.onclick = () => {
      const captureCanvas = document.createElement("canvas");
      captureCanvas.width = overlayCanvas.width;
      captureCanvas.height = overlayCanvas.height;
      const cctx = captureCanvas.getContext("2d");
      cctx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
      if (currentTattoo) {
        const w = captureCanvas.width * tattooScale;
        const h = (currentTattoo.height / currentTattoo.width) * w;
        cctx.save();
        cctx.translate(captureCanvas.width * tattooX, captureCanvas.height * tattooY);
        cctx.rotate(tattooAngle);
        cctx.drawImage(currentTattoo, -w / 2, -h / 2, w, h);
        cctx.restore();
      }
      const link = document.createElement("a");
      link.download = "tattoo-preview.png";
      link.href = captureCanvas.toDataURL("image/png");
      link.click();
    };

    // === –í–ê–ñ–õ–ò–í–û: canvas —Ç–µ–ø–µ—Ä —Ä–µ–∞–≥—É—î –Ω–∞ –ø–æ–¥—ñ—ó ===
    overlayCanvas.addEventListener("touchstart", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { x: touches[i].clientX, y: touches[i].clientY };
      }
      if (touches.length === 1) {
        const rect = overlayCanvas.getBoundingClientRect();
        const xOnCanvas = (touches[0].clientX - rect.left) / rect.width;
        const yOnCanvas = (touches[0].clientY - rect.top) / rect.height;
        const dx = xOnCanvas - tattooX;
        const dy = yOnCanvas - tattooY;
        // –†–æ–∑—à–∏—Ä—é—î–º–æ –∑–æ–Ω—É –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è
        if (Math.hypot(dx, dy) < tattooScale * 2) {
          isDragging = true;
          dragOffsetX = touches[0].clientX - overlayCanvas.width * tattooX;
          dragOffsetY = touches[0].clientY - overlayCanvas.height * tattooY;
          manualMode = true;
        }
      }
    });

    overlayCanvas.addEventListener("touchmove", (e) => {
      if (!currentTattoo) return;
      e.preventDefault();
      const touches = e.touches;
      for (let i = 0; i < touches.length; i++) {
        activeTouches[touches[i].identifier] = { x: touches[i].clientX, y: touches[i].clientY };
      }
      if (touches.length === 1 && isDragging) {
        tattooX = (e.touches[0].clientX - dragOffsetX) / overlayCanvas.width;
        tattooY = (e.touches[0].clientY - dragOffsetY) / overlayCanvas.height;
        redrawTattoo();
      } else if (touches.length === 2) {
        const t1 = activeTouches[e.touches[0].identifier];
        const t2 = activeTouches[e.touches[1].identifier];
        if (t1 && t2) {
          const dx = t1.x - t2.x;
          const dy = t1.y - t2.y;
          const distance = Math.sqrt(dx * dx + dy * dy);
          const newScale = Math.max(0.1, Math.min(1.0, distance / (overlayCanvas.width * 0.8)));
          tattooScale = newScale;
          manualMode = true;
          redrawTattoo();
        }
      }
    });

    overlayCanvas.addEventListener("touchend", (e) => {
      if (!currentTattoo) return;
      for (let i = 0; i < e.changedTouches.length; i++) {
        delete activeTouches[e.changedTouches[i].identifier];
      }
      if (e.touches.length === 0) {
        isDragging = false;
      }
    });

    // === –í–ò–ü–†–ê–í–õ–ï–ù–û: –í–ò–ö–û–†–ò–°–¢–û–í–£–Ñ–ú–û .task ===
    import { PoseLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12";

    let poseLandmarker = null;

    async function initPose() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.12/wasm"
      );
      poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
        baseOptions: {
          modelAssetPath: "https://storage.googleapis.com/mediapipe-assets/pose_landmarker_lite.task"
        },
        runningMode: "VIDEO",
        numPoses: 1
      });
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }
      });
      video.srcObject = stream;
      await video.play();
      resizeCanvas();
      window.addEventListener("resize", resizeCanvas);
      loading.style.display = "none";
    }

    let lastVideoTime = -1;
    function detectPose() {
      if (video.currentTime !== lastVideoTime && poseLandmarker) {
        lastVideoTime = video.currentTime;
        const results = poseLandmarker.detectForVideo(video, performance.now());
        if (results.landmarks && results.landmarks.length > 0) {
          attachTattooToBody(results.landmarks[0]);
        }
      }
      requestAnimationFrame(detectPose);
    }

    buildTattooPicker();
    buildBodyPartSelector();
    Promise.all([setupCamera(), initPose()])
      .then(() => detectPose())
      .catch(err => {
        console.error("Init error:", err);
        loading.innerHTML = "‚ùå Failed to start<br><small>Try Chrome/Safari on mobile</small>";
      });
  </script>
</body>
</html>
